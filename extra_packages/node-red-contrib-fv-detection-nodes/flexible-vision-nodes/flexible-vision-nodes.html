<!-- set device ip inputs -->
<script type="text/html" data-template-name="server-settings">
    <div class="form-row">
        <label for="node-config-input-workstation"><i class="fa fa-desktop" aria-hidden="true"></i> workstation</label>
        <input type="text" id="node-config-input-workstation">
    </div>
    <div class="form-row">
        <label for="node-config-input-username"><i class="fa fa-user" aria-hidden="true"></i> Username</label>
        <input type="text" id="node-config-input-username">
    </div>
    <div class="form-row">
        <label for="node-config-input-password"><i class="fa fa-lock" aria-hidden="true"></i> Password</label>
        <input type="password" id="node-config-input-password">
    </div>
    <div class="form-row">
        <label for="node-config-input-host"><i class="fa fa-server" aria-hidden="true"></i> FV Server IP</label>
        <input type="text" id="node-config-input-host" placeholder="123.45.6.7">
    </div>
</script>

<script type="text/html" data-help-name="server-settings">
    <p>Flexible Vision Server Hostname</p>
</script>

<!-- fv upload inputs -->
<script type="text/html" data-template-name="onprem-upload">
    <div class="form-row">
        <label for="node-input-fvconfig"><i class="fa fa-server" aria-hidden="true"></i> FV Server IP</label>
        <select id="node-input-fvconfig"></select>
    </div>
    <div class="form-row">
        <label for="node-input-preset"><i class="fa fa-sliders" aria-hidden="true"></i> Presets</label>
        <select type="text" id="node-input-preset" class="preset-select">
            <option>Set your server IP</option>
        </select>
    </div>
    <!-- <div class="form-row">
        <label for="node-input-model"><i class="fa fa-folder" aria-hidden="true"></i> Models</label>
        <select type="text" id="node-input-model" class="model-select">
          <option>Set your server ip to load models.</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-version"><i class="fa fa-align-justify" aria-hidden="true"></i> Versions</label>
        <select type="text" id="node-input-version" class="version-select">
          <option>Set your server ip to load model versions.</option>
        </select>
    </div> -->
</script>

<script type="text/html" data-help-name="onprem-upload">
    <p>Calls a set preset to run prediction on buffer image object.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>msg.file
            <span class="property-type">buffer object</span>
        </dt>
        <dd>Image as buffer object.</dd>
        <dt>msg.did
            <span class="property-type">String</span>
        </dt>
        <dd>"did" (detection ID) uniquely set detection identifier to reference via detection history.</dd>
    </dl>

    <h3>Outputs</h3>
    <ol class="node-ports">
        <li>Standard output
            <dl class="message-properties">
                <dt>payload <span class="property-type">JSON object</span></dt>
                <dd>Predicted details in JSON format.</dd>
            </dl>
        </li>
        <li>Standard error
            <dl class="message-properties">
                <dt>payload <span class="property-type">JSON object</span></dt>
                <dd>Error information in JSON format.</dd>
            </dl>
        </li>
    </ol>
</script>
<!-- fv upload inputs END -->

<!-- fv snap inputs -->
<script type="text/html" data-template-name="onprem-snap">
    <div class="form-row">
        <label for="node-input-fvconfig"><i class="fa fa-server" aria-hidden="true"></i> FV Server IP</label>
        <select id="node-input-fvconfig"></select>
    </div>
    <div class="form-row">
        <label for="node-input-preset"><i class="fa fa-sliders" aria-hidden="true"></i> Presets</label>
        <select type="text" id="node-input-preset" class="preset-select">
            <option>Set your server IP</option>
        </select>
    </div>
    <!-- <div class="form-row">
        <label for="node-input-camera"><i class="fa fa-video-camera" aria-hidden="true"></i> Cameras</label>
        <select type="text" id="node-input-camera" class="camera-select" >
          <option>Set your server ip to load cameras</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-mask"><i class="fa fa-window-maximize" aria-hidden="true"></i> Masks</label>
        <select type="text" id="node-input-mask" class="mask-select">
          <option>Set your server ip to load masks.</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-model"><i class="fa fa-folder" aria-hidden="true"></i> Models</label>
        <select type="text" id="node-input-model" class="model-select">
          <option>Set your server ip to load models.</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-version"><i class="fa fa-align-justify" aria-hidden="true"></i> Versions</label>
        <select type="text" id="node-input-version" class="version-select">
          <option>Set your server ip to load model versions.</option>
        </select>
    </div> -->
</script>

<script type="text/html" data-help-name="onprem-snap">
    <p>Calls a set preset to run prediction on buffer image object.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>msg.did
            <span class="property-type">String</span>
        </dt>
        <dd>"did" (detection ID) uniquely set detection identifier to reference via detection history.</dd>
    </dl>

    <h3>Outputs</h3>
    <ol class="node-ports">
        <li>Standard output
            <dl class="message-properties">
                <dt>payload <span class="property-type">JSON object</span></dt>
                <dd>Predicted details in JSON format.</dd>
            </dl>
        </li>
        <li>Standard error
            <dl class="message-properties">
                <dt>payload <span class="property-type">JSON object</span></dt>
                <dd>Error information in JSON format.</dd>
            </dl>
        </li>
    </ol>
</script>
<!-- fv snap inputs END -->

<!-- get pin state START -->
<script type="text/html" data-template-name="pin-state-get">
    <div class="form-row">
        <label for="node-input-fvconfig"><i class="fa fa-server" aria-hidden="true"></i> FV Server IP</label>
        <select id="node-input-fvconfig"></select>
    </div>
    <div class="form-row">
        <label for="node-input-project"><i class="fa connectdevelop" aria-hidden="true"></i> Pins</label>
        <select type="text" id="node-input-pin"></select>
    </div>
</script>
<!-- get pin state END -->

<!-- set pin state START -->
<script type="text/html" data-template-name="pin-state-set">
    <div class="form-row">
        <label for="node-input-fvconfig"><i class="fa fa-server" aria-hidden="true"></i> FV Server IP</label>
        <select id="node-input-fvconfig"></select>
    </div>
    <div class="form-row">
        <label for="node-input-project"><i class="fa connectdevelop" aria-hidden="true"></i> Pins</label>
        <select type="text" id="node-input-pin">
            <option value="1">GP1</option>
            <option value="2">GP2</option>
            <option value="3">GP3</option>
            <option value="4">GP4</option>
            <option value="5">GP5</option>
            <option value="6">GP6</option>
            <option value="7">GP7</option>
            <option value="8">GP8</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-state"><i class="fa fa-toggle-on" aria-hidden="true"></i> Enable</label>
        <input type="checkbox" id="node-input-state">
    </div>
</script>
<!-- set pin state END -->

<!-- fv cloud upload inputs -->
<script type="text/html" data-template-name="cloud-upload">
    <div class="form-row">
        <label for="node-input-username"><i class="icon-tag"></i> Username</label>
        <input type="text" id="node-input-username">
    </div>
    <div class="form-row">
        <label for="node-input-password"><i class="icon-tag"></i> Password</label>
        <input type="password" id="node-input-password">
    </div>
    <div class="form-row">
        <label for="node-input-project"><i class="fa fa-folder" aria-hidden="true"></i> Projects</label>
        <select type="text" id="node-input-project" class="cloud-project-select"></select>
    </div>
    <div class="form-row">
        <input type="hidden" id="node-input-auth"></input>
    </div>
</script>
<!-- fv cloud upload inputs END -->

<script type="text/html" data-help-name="cloud-upload">
    <p>Runs prediction on buffer image object.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload
            <span class="property-type">buffer object</span>
        </dt>
        <dd> Image as buffer object.</dd>
    </dl>

    <h3>Outputs</h3>
    <ol class="node-ports">
        <li>Standard output
            <dl class="message-properties">
                <dt>payload <span class="property-type">JSON object</span></dt>
                <dd>Predicted details in JSON format.</dd>
            </dl>
        </li>
        <li>Standard error
            <dl class="message-properties">
                <dt>payload <span class="property-type">JSON object</span></dt>
                <dd>Error information in JSON format.</dd>
            </dl>
        </li>
    </ol>
</script>


<script type="text/javascript">
    (function () {
        const FV_DOMAIN = 'v1.cloud.flexiblevision.com';
        let VERSION = null,
            MODEL = 'LOADING MODELS...',
            MASK = null,
            CAMERA = null

        const main = function (model, version, preset) {
            VERSION = version;
            MODEL = model;
            PRESET = preset;

            var host = $('#node-input-fvconfig option:selected').text();
            populatePresets(host);
            // initCams(host)
            // PopulateModels(host);
            // $('.version-select').hide();
            // $('.mask-select').hide();
        }

        const snapMain = function (model, version, mask, camera, preset) {
            VERSION = version;
            MODEL = model;
            MASK = mask;
            CAMERA = camera;
            PRESET = preset;

            var host = $('#node-input-fvconfig option:selected').text();
            populatePresets(host);
            // initCams(host)
            // PopulateModels(host);
            // populateMasks(host);


            // if (version) {
            //     $('.version-select').show();
            //     PopulateModelVersions(host)
            // }else{
            //     $('.version-select').hide();
            // }
        }

        // const initCams = function(host) {
        //     if (host && host[0] != 'A'){
        //         PopulateCameras(host);
        //     }else{
        //         $('#node-input-model').html('<option>Please configure server IP</options>');
        //     }
        // }

        // $(document).on('click change', '.model-select', function() {
        //     var host  = $('#node-input-fvconfig option:selected').text();
        //     var model = $('#node-input-model option:selected').text();

        //     MODEL = model;
        //     if (host && host[0] != 'A' && MODEL && MODEL[0] != '!'){
        //         $('.version-select').show();
        //         PopulateModelVersions(host);
        //     }else{
        //         $('#node-input-version').html('<option>!Could not load versions.</options>');
        //     }
        // });

        $(document).on('click change', '.preset-select', function () {
            var host = $('#node-input-fvconfig option:selected').text();
            var preset = $('#node-input-preset option:selected').text();
            PRESET = preset;
        });

        // $(document).on('change', '.version-select', function() {
        //     var host = $('#node-input-fvconfig option:selected').text();
        //     if (host && host[0] != 'A'){
        //         $('.camera-select').show();
        //         PopulateCameras(host);
        //     }else{
        //         $('#node-input-camera').html('<option>!Could not load cameras.</options>');
        //     }
        // });

        const populatePresets = function (host) {
            if (host && host[0] == 'A') {
                console.log("Select a server host");
                return false;
            }

            var url = 'http://' + host + ':5000/api/capture/io/';
            $('#node-input-preset').html('<option>' + PRESET + '</options>');

            $.ajax({
                url: url,
                dataType: "json"
            }).done(function (data) {
                $('#node-input-preset').html('');
                for (var d = 0; d < data.length; d++) {
                    var option = document.createElement("option");
                    option.text = 'Preset: ' + data[d].presetId;
                    option.value = data[d].presetId;
                    if (PRESET == data[d].presetId) {
                        option.selected = true
                    }
                    var select = document.getElementById("node-input-preset");
                    select.appendChild(option);
                }
            }).error(function (err) {
                $('#node-input-preset').html('Error loading models');
                console.log(err);
            });
        }

        // const PopulateModelVersions = function(host){
        //     if (host && host[0] == 'A' && MODEL[0] == '!') {
        //       console.log("Select a model.");
        //       return false;
        //     }

        //     var url = 'http://'+host+':5000/api/capture/system/'+MODEL+'/versions';
        //     $('#node-input-version').html('<option>Loading versions...</options>');
        //     $.ajax({
        //       url: url,
        //       dataType: "json"
        //     }).done(function (data) {
        //       $('#node-input-version').html('');
        //       for (var d=0; d < data.length; d++) {

        //           var option = document.createElement("option");
        //           option.text = data[d];
        //           option.value = data[d];
        //           if (VERSION == data[d]) {
        //               option.selected = true
        //           }
        //           var select = document.getElementById("node-input-version");
        //           select.appendChild(option);

        //           // var selected = data[d] == VERSION;
        //           // $('<option/>',{
        //           //     'value': data[d],
        //           //     'text': data[d],
        //           //     'selected': selected
        //           // }).appendTo('#node-input-version');
        //       }
        //     }).error(function(err){
        //         console.log(err)
        //       $('#node-input-version').html('Error loading versions');
        //       console.log(err);
        //     });
        // }

        // const PopulateCameras = function(host) {

        //   if (host && host[0] == 'A') {
        //     return false;
        //   }

        //   var url = 'http://'+host+':5000/api/capture/camera/';
        //   $('#node-input-camera').html('<option>Loading cameras...</options>');

        //   $.ajax({
        //     url: url,
        //     dataType: "json"
        //   }).done(function (data) {

        //     $('#node-input-camera').html('');
        //     for (var d=0; d < data.length; d++) {

        //         var option = document.createElement("option");
        //         option.text = data[d].name;
        //         option.value = data[d].index+"#"+data[d].uid;
        //         if (CAMERA == data[d].index+"#"+data[d].uid) {
        //             option.selected = true
        //         }
        //         var select = document.getElementById("node-input-camera");
        //         select.appendChild(option);

        //         // var selected = data[d].index+"#"+data[d].uid == CAMERA;
        //         // $('<option/>',{
        //         //     'value': data[d].index+"#"+data[d].uid,
        //         //     'text': data[d].name,
        //         //     'selected': selected
        //         // }).appendTo('#node-input-camera');
        //     }
        //   }).error(function(err){
        //     $('#node-input-camera').html('Error loading cameras');
        //     console.log(err);
        //   });
        // }


        // cloud node functions----------------------------------------------

        function login_user(username, password) {
            // encrypt username and password before making http request
            // var path = 'https://v1.cloud.flexiblevision.com/';
            var path = 'https://' + FV_DOMAIN + '/api/capture/auth/node_login';
            var creds = JSON.stringify({username: username, password: password});
            if (username && password) {
                var settings = {
                    method: 'POST',
                    async: false,
                    dataType: "json",
                    url: path,
                    headers: {'content-type': 'application/json'},
                    data: creds,
                    success: function (data) {
                        if (data) {
                            var auth_token = data["access_token"];
                            loadProjects(auth_token);
                            $("#node-input-auth").val(auth_token);
                        }

                    },
                    error: function () {
                        loadProjects(false);
                    }
                }
                $.ajax(settings);
            }
        }

        function get_token(username, password, auth_token) {
            if (auth_token) {
                if (isTokenExpired(auth_token)) {
                    console.log('token expired, getting new auth token...');
                    login_user(username, password);
                } else {
                    console.log('getting saved auth token...');
                    loadProjects(auth_token);
                    return auth_token;
                }
            } else {
                console.log('getting new auth token...');
                login_user(username, password);
            }
        }

        function isTokenExpired(token) {
            if (token) {
                var hr_seconds = 3600;
                const token_header = token.split('.')[1];
                const decodedString = JSON.parse(window.atob(token_header));
                var token_expires = decodedString.exp - hr_seconds;
                var d = new Date();
                var t = d.getTime() / 1000;
                return t > token_expires;
            } else {
                return true;
            }
        }

        const cloudMain = function (username, password, auth_token) {
            loadProjects(auth_token);
        }

        const encryptPassword = function () {
            $("#node-input-password").focusout(function () {
                var password = $("#node-input-password").val();
                try {
                    console.log(password, '<<<current password');
                    var decodedPw = window.atob(password);
                    console.log(decodedPw, ' decoded');
                    var encodedPw = window.btoa(decodedPw);
                } catch (e) {
                    var encodedPw = window.btoa(decodedPw);
                }

                $("#node-input-password").val(encodedPw);
                console.log(encodedPw);
            });
        }

        const loadProjects = function (auth_token) {
            const url = 'https://' + FV_DOMAIN + '/api/capture/project/';
            if (auth_token) {
                $.ajax({
                    method: 'GET',
                    url: url,
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + auth_token,
                        "access_token": auth_token
                    }
                }).done(function (res) {
                    $('#node-input-project').html('');
                    const data = res.records;
                    for (var d = 0; d < data.length; d++) {
                        var option = document.createElement("option");
                        option.text = data[d].name;
                        option.value = data[d].id;
                        var select = document.getElementById("node-input-project");
                        select.appendChild(option);
                    }
                }).error(function (err) {
                    $('#node-input-project').html('Error loading projects');
                    console.log(err);
                });
            } else {
                $('#node-input-project').html('Error loading projects')
            }
        }

        // cloud node functions----------------------------------

        RED.nodes.registerType('server-settings', {
            category: 'config',
            defaults: {
                workstation: {value: "", required: false},
                username: {value: "", required: false},
                password: {value: "", required: false},
                host: {value: "", required: true},
            },
            inputs: 0,
            outputs: 0,
            label: function () {
                return this.host;
            },
            oneditsave: function () {
                main();
            }
        });

        RED.nodes.registerType('onprem-upload', {
            category: 'Flexible Vision',
            color: '#00bcd4',
            defaults: {
                preset: {value: this.preset, required: true},
                // model: {value: this.model,required:true},
                // version: {value: this.version, required:true},
                fvconfig: {type: "server-settings", required: true}
            },
            inputs: 1,
            outputs: 1,
            icon: "outline-visibility-24px.svg",
            label: function () {
                return "OnPrem Upload - " + "PRESET: " + this.preset;
            },
            oneditprepare: function (e) {
                main(this.model, this.version, this.preset);
            }
        });

        RED.nodes.registerType('onprem-snap', {
            category: 'Flexible Vision',
            color: '#ffdb20',
            defaults: {
                preset: {value: this.preset, required: true},
                // model: {value: this.model,required:true},
                // version: {value: this.version, required:true},
                // camera: {value: this.camera, required:true},
                // mask: {value: this.mask, required: false},
                fvconfig: {type: "server-settings", required: true},
            },
            inputs: 1,
            outputs: 1,
            icon: "outline-videocam-24px.svg",
            label: function () {
                return "Onprem Snap - " + "PRESET: " + this.preset;
            },
            oneditprepare: function () {
                snapMain(this.model, this.version, this.mask, this.camera, this.preset);
            }
        });

        RED.nodes.registerType('cloud-upload', {
            category: 'Flexible Vision',
            color: '#00bcd4',
            defaults: {
                username: {value: "", required: true},
                password: {value: "", required: true},
                project: {value: "", required: true},
                auth: {value: ""}
            },
            inputs: 1,
            outputs: 1,
            icon: "outline-videocam-24px.svg",
            label: function () {
                return "Cloud Upload " + this.project;
            },
            oneditprepare: function () {
                //encryptPassword(this.password);
                get_token(this.username, this.password, this.auth);
                // cloudMain(this.username, this.password, this.auth);
            }
        });

        RED.nodes.registerType('pin-state-get', {
            category: 'Flexible Vision',
            color: '#078668',
            defaults: {
                fvconfig: {type: "server-settings", required: true},
                pin: {value: '', required: true}
            },
            inputs: 1,
            outputs: 1,
            icon: "fiber_pin_black_24dp.svg",
            label: function () {
                return 'get ' + this.pin + ' state';
            },
            oneditprepare: function () {
                var host = $('#node-input-fvconfig option:selected').text();
                if (host) {
                    let url = 'http://192.168.196.2:5000/api/capture/io/cur_pins_state';

                    $('#node-input-pin').html('');

                    $.ajax({
                        url: url,
                        dataType: "json"
                    }).done((data) => {
                        console.log(data)
                        const select = document.getElementById("node-input-pin");
                        select.innerText = '';
                        let src = false;
                        for (let key in data) {
                            if (key.indexOf('GP') !== 0) continue;
                            var option = document.createElement("option");
                            option.text = key;
                            option.value = key;
                            if (this.pin == key) {
                                option.selected = true
                                src = key;
                            }
                            select.appendChild(option);
                        }
                    }).error(function (err) {
                        $('#node-input-pin').html('<option value="">Error loading pins</option>');
                        console.log(err);
                    });
                }
            }
        });

        RED.nodes.registerType('pin-state-set', {
            category: 'Flexible Vision',
            color: '#55ff00',
            defaults: {
                fvconfig: {type: "server-settings", required: true},
                pin: {value: '', required: true},
                state: {value: false, required: true}
            },
            inputs: 1,
            outputs: 1,
            icon: "fiber_pin_black_24dp.svg",
            label: function () {
                return (this.state ? " enable " : "disable ") + this.pin;
            }
        });

        RED.nodes.registerType('motion-detection', {
            category: 'Flexible Vision',
            color: '#d09f25',
            label: 'Detect Motion',
            defaults: {
                fvconfig: {type: "server-settings", required: true},
                camlocation: {type: "camera-server", required: true},
                camId: {value: "", required: true},
                mask: {value: false}, // false === unloaded, null === 'no mask', value as ID of mask
                threshold: {value: 85, required: true, validate: RED.validators.number()},
                debounce: {value: 250, required: false, validate: RED.validators.number()}
            },
            inputs: 1,
            outputs: 2,
            icon: "motion_photos_auto_black_24dp.svg",
            outputLabels: ["Motion", "No Motion"],
            oneditsave: function () {
                this.mask = $('#node-input-mask').val();
                this.debounce = $('#node-input-debounce').val();
                this.threshold = $('#node-i' +
                    'nput-threshold').val();
            },
            oneditprepare: function () {
                var camlocation = $('#node-input-camlocation option:selected').text();

                if (camlocation && !camlocation.indexOf('...')) {
                    // get cameras
                    const camController = new CameraController($, {
                        camlocation: this.camlocation,
                        camId: this.camId,
                    })
                    camController.startListeners();
                    window.camController = camController; // debugging

                    document.getElementById("fvCamForm").addEventListener('updateToolContext',
                        (e) => {
                            this.camlocation = e.detail.host
                            this.camId = e.detail.camId
                            console.log('ON UPDATE ' + e.detail.camId);
                        },
                        {capture: false}
                    );

                    // get masks

                    let url = camlocation + '/api/capture/mask/get_masks';
                    if (!this.mask || this.mask == '') {
                        $('#node-input-mask').html('<option value="">Loading masks...</option>');
                    }

                    $.ajax({
                        url: url,
                        dataType: "json"
                    }).done((data) => {
                        if (!this.mask || this.mask == '') {
                            $('#node-input-mask').html('<option value="">No mask</option>');
                        }
                        var select = document.getElementById("node-input-mask");
                        let src = false;
                        for (var d = 0; d < data.length; d++) {
                            var option = document.createElement("option");
                            option.text = data[d]['maskName'];
                            option.value = data[d]['maskId'];
                            if (this.mask == data[d]['maskId']) {
                                option.selected = true
                                src = data[d].b64Mask;
                            }
                            select.appendChild(option);
                        }
                        if (src) {
                            $("#maskpreview").attr('src', src).show();
                        } else {
                            $("#maskpreview").hide()
                        }

                    }).error(function (err) {
                        $('#node-input-mask').html('<option value="">Error loading masks from ' + url + '</option>');
                        console.log(err);
                    });
                }

            }
        });


        RED.nodes.registerType('image-manipulation', {
            category: 'Flexible Vision',
            color: '#857d0c',
            label: function () {
                if (this.efx_name && this.efx_name.length > 0) {
                    return this.efx_name;
                } else {
                    return 'Effect Image';
                }
            },
            defaults: {
                fvconfig: {type: "server-settings", required: true},
                efx_value: {value: '', required: true, disabled: true},
                efx_name: {value: false, required: true}
            },
            inputs: 1,
            outputs: 1,
            icon: "blur_on_FILL0_wght400_GRAD0_opsz24.svg",
            oneditsave: function () {
                const form = document.getElementById("cv2form");
                const formData = {}
                for (let i = 0; i < form.elements.length; i++) {
                    const field = form.elements[i];
                    if (field.name && field.value && field.value != '' && field.value != 'undefined' && field.value != 'null') {
                        formData[field.name] = field.value;
                    }
                }

                this.efx_value = formData;
                $('#node-input-efx_value').val(JSON.stringify(formData));
            },

            oneditprepare: function () {
                let FILTERS = {}

                const buildParametersForm = () => {
                    const efx_name = $('#node-input-efx_name').val();

                    if (Object.keys(FILTERS).length === 0) return false; // still loading

                    if (typeof FILTERS[efx_name] === 'undefined') {
                        console.error('invalid filter name ' + efx_name, FILTERS);
                        return false;
                    }

                    const existing = this.efx_value ? JSON.parse(this.efx_value) : {};
                    console.log('render filter: ' + efx_name, existing);


                    let formHtml = '';

                    document.getElementById("cv2description").innerText = FILTERS[efx_name]['description'];
                    document.getElementById("cv2params").innerText = '';

                    for (let param in FILTERS[efx_name].params) {
                        if (param === 'src' || param === 'dst') continue;

                        const desc = FILTERS[efx_name].params[param];

                        let defaultValue = '', match = desc.match(/default:\s+([^)]*)/);
                        if (match && match.length > 1) {
                            defaultValue = match[1].trim();

                        }

                        let initValue = (typeof existing[param] !== 'undefined') ? existing[param] : defaultValue;
                        const isRequired = desc.indexOf('optional') > -1 ? '' : '<span style="color:red">*</span>'
                        formHtml += '<div class="form-row">'
                        formHtml += '<label for="' + param + '">' + param + isRequired + '</label>';
                        formHtml += '<input class="form-control" type="text" id="' + param + '" name="' + param + '" ' +
                            'placeholder="' + defaultValue + '" value="' + initValue + '">';
                        formHtml += `<small style="margin-left:100px; display: block" class="form-text text-muted">${desc}</small>`;
                        formHtml += '</div>'

                    }

                    $('#cv2form').html(formHtml);

                }

                $('#node-input-efx_name').on("change", function () {
                    $('#node-input-efx_value').val();
                    buildParametersForm();
                });

                fetch('resources/node-red-contrib-fv-detection-nodes/api/opencv-filters.json', {
                    headers: {'Content-Type': 'application/json'}
                })
                    .then(response => response.json())
                    .then(json => {
                        FILTERS = json
                        buildParametersForm();
                        console.log('filters: ', FILTERS)
                    })
                    .catch((error) => {
                        alert(error);
                        console.error('Error:', error);
                    });

            }
        });

    })();
</script>


<!-- VISION NODES -->


<!-- MOTION DETECTION START -->
<script type="text/html" data-template-name="motion-detection">
    <link rel="stylesheet" href="resources/node-red-contrib-fv-detection-nodes/camera-controller.css"/>
    <div class="form-row">
        <label for="node-input-fvconfig"><i class="fa fa-server" aria-hidden="true"></i> FV Server IP</label>
        <select id="node-input-fvconfig"></select>
    </div>
    <div id="fvCamForm">
        <div class="form-row">
            <label for="node-input-camlocation"><i class="fa fa-link"></i> Cam Location</label>
            <input type="url" id="node-input-camlocation">
        </div>
        <div class="form-row">
            <label for="node-input-camera"><i class="fa fa-camera"></i> Target Cam</label>
            <select id="node-input-camera"></select>
            <button type="button" class="red-ui-button" id="allCamRefreshBtn">Refresh</button>
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-mask"><i class="fa fa-bullseye"></i> Mask</label>
        <select id="node-input-mask">
            <option value="">No mask</option>
        </select>
        <span style="background-color:#ccc; height:40px"><img style="display: none; max-height:40px" id="maskpreview"/></span>
    </div>
    <div class="form-row">
        <label for="node-input-threshold"><i class="fa fa-percent"></i> Threshold</label>
        <input type="text" id="node-input-threshold" placeholder="Enter minimum change threshold (%)">
    </div>
    <div class="form-row">
        <label for="node-input-debounce"><i class="fa fa-hourglass-end"></i> Debounce (milliseconds)</label>
        <input type="text" id="node-input-debounce" placeholder="250 milliseconds">
    </div>
</script>
<!-- MOTION DETECTION END -->


<!-- IMAGE MANIPULATION START -->
<script type="text/html" data-template-name="image-manipulation">
    <link rel="stylesheet" href="resources/node-red-contrib-fv-detection-nodes/camera-controller.css"/>
    <div class="form-row">
        <label for="node-input-fvconfig"><i class="fa fa-server" aria-hidden="true"></i> FV Server IP</label>
        <select id="node-input-fvconfig"></select>
    </div>
    <div class="form-row">
        <label for="node-input-efx_name"><i class="fa fa-eercast"></i> Effect Type</label>
        <select id="node-input-efx_name">
            <option value="remove_bgr">Remove Background</option>
            <option value="cvtColor">Convert Color Scale</option>
            <optgroup label="Blur Filters">
                <option value="GaussianBlur">Gaussian Blur</option>
                <option value="medianBlur">Median Blur</option>
                <option value="bilateralFilter">Bilateral Filter</option>
            </optgroup>
            <optgroup label="Edge Detection Filters">
                <option value="Canny">Canny Edge Detection</option>
                <option value="Sobel">Sobel Filter</option>
                <option value="Laplacian">Laplacian Filter</option>
            </optgroup>
            <option value="adaptiveThreshold">Adaptive Thresholding</option>
            <option value="fastNlMeansDenoising">Fast Non-Local Means Denoising</option>
            <optgroup label="Morphological Filters">
                <option value="erode">Erosion</option>
                <option value="dilate">Dilation</option>
                <option value="morphologyEx">Morphology Operations</option>
            </optgroup>
            <optgroup label="Histogram Equalization">
                <option value="equalizeHist">Equalize Histogram</option>
            </optgroup>
            <optgroup label="Custom Kernel Convolution">
                <option value="filter2D">Custom Kernel Convolution</option>
            </optgroup>
            <optgroup label="Resize and Scaling">
                <option value="resize">Resize and Scaling</option>
            </optgroup>
            <optgroup label="Rotation and Affine Transformations">
                <option value="getRotationMatrix2D">Get Rotation Matrix</option>
                <option value="warpAffine">Warp Affine</option>
            </optgroup>
            <optgroup label="Image Warping">
                <option value="warpPerspective">Image Warping</option>
            </optgroup>
            <optgroup label="Image Blending">
                <option value="addWeighted">Image Blending</option>
            </optgroup>
        </select>
        <blockquote style="display:none;">
            <div style="font-weight:700" id="cv2description"></div>
            <code>
                <dl id="cv2params"></dl>
            </code>
        </blockquote>
    </div>
    <div class="form-row" style="opacity:0.3;">
        <label for="node-input-efx_value"><i class="fa fa-snowflake-o"></i> Effect Value</label>
        <input type="text" disabled id="node-input-efx_value">
    </div>
    <blockquote class="form-group">
        <form id="cv2form" name="cv2form"></form>
    </blockquote>
</script>
<!-- IMAGE MANIPULATION END -->


<!-- UPDATE INFERENCE START -->
<script type="text/html" data-template-name="update-inference">
    <link rel="stylesheet" href="resources/node-red-contrib-fv-detection-nodes/camera-controller.css"/>
    <div class="form-row">
        <label for="node-input-fvconfig"><i class="fa fa-server" aria-hidden="true"></i> FV Server IP</label>
        <select id="node-input-fvconfig"></select>
    </div>
    <div class="form-row">
        <label for="node-input-inferenceobj"><i class="fa fa-percent"></i> Target Inference Object</label>
        <input type="text" id="node-input-inferenceobj" placeholder="Target Inference Object">
    </div>
    <div class="form-row">
        <label for="node-input-metadata"><i class="fa fa-hourglass-end"></i> Metadata to Add</label>
        <input type="text" id="node-input-metadata" placeholder="json object">
    </div>
</script>
<!-- UPDATE INFERENCE END -->

<script type="text/html" data-template-name="camera-server">
    <div class="form-row">
        <label for="node-config-input-camlocation"><i class="fa fa-link"></i> Host : Port</label>
        <input type="url" id="node-config-input-camlocation" placeholder="http://locahost:8080">
    </div>
</script>

<script type="text/html" data-help-name="camera-server">
    <p>Camera Location</p>
</script>

<script type="text/javascript" src="resources/node-red-contrib-fv-detection-nodes/camera-controller.js"/>



<script type="text/html" data-template-name="set-camera-property">
    <link rel="stylesheet" href="resources/node-red-contrib-fv-detection-nodes/camera-controller.css"/>
    <div id="fvCamForm">
        <div class="form-row">
            <label for="node-input-camlocation"><i class="fa fa-link"></i> Cam Location</label>
            <select id="node-input-camlocation"></select>
        </div>
        <div class="form-row">
            <label for="node-input-camera"><i class="fa fa-camera"></i> Target Cam</label>
            <select id="node-input-camera"></select>
            <button type="button" class="red-ui-button" id="allCamRefreshBtn">Refresh</button>
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-camprop"><i class="fa fa-tag"></i> Cam Property</label>
        <select id="node-input-camprop"></select>
    </div>
    <div class="form-row" id="fvPropValRow">
        <label for="node-input-propval"><i class="fa fa-outdent"></i> Property Value</label>
        <select id="node-input-propval"></select>
    </div>
    <div id="camPropertyDesc"></div>
    </div>
</script>

<script type="text/html" data-help-name="set-camera-property">
    <p>Camera Property Options</p>
    <div id="camPropertyHelp"></div>
</script>

<script type="text/html" data-template-name="release-camera">
    <link rel="stylesheet" href="resources/node-red-contrib-fv-detection-nodes/camera-controller.css"/>
    <div id="fvCamForm">
        <div class="form-row">
            <label for="node-input-camlocation"><i class="fa fa-link"></i> Cam Location</label>
            <select id="node-input-camlocation"></select>
        </div>
        <div class="form-row">
            <label for="node-input-camera"><i class="fa fa-camera"></i> Target Cam</label>
            <select id="node-input-camera"></select>
            <button type="button" class="red-ui-button" id="allCamRefreshBtn">Refresh</button>
        </div>
    </div>
</script>

<script type="text/html" data-template-name="open-camera">
    <link rel="stylesheet" href="resources/node-red-contrib-fv-detection-nodes/camera-controller.css"/>
    <div id="fvCamForm">
        <div class="form-row">
            <label for="node-input-camlocation"><i class="fa fa-link"></i> Cam Location</label>
            <select id="node-input-camlocation"></select>
        </div>
        <div class="form-row">
            <label for="node-input-camera"><i class="fa fa-camera"></i> Target Cam</label>
            <select id="node-input-camera"></select>
            <button type="button" class="red-ui-button" id="allCamRefreshBtn">Refresh</button>
        </div>
    </div>
</script>

<script type="text/javascript">
    (function () {

        RED.nodes.registerType('camera-server', {
            category: 'config',
            paletteLabel: 'Camera Server',
            defaults: {
                camlocation: {value: "http://172.17.0.1:5555", required: true}
            },
            inputs: 0,
            outputs: 0,
            label: function () {
                return this.camlocation || this.host;
            }
        });

        RED.nodes.registerType('set-camera-property', {
            category: 'Flexible Vision',
            paletteLabel: 'Configure Camera',
            color: '#42A5F5',
            defaults: {
                camlocation: {type: "camera-server", required: true},
                camId: {value: "", required: true},
                camProp: {value: "", required: true},
                propVal: {value: "", required: true},
                host: {value: "", required: false, hidden: true},
                access_mode: {value: "", required: false, hidden: true},
                node_type: {value: "", required: false, hidden: true},
                camProperty: {value: {}, required: false, hidden: true},
                lastUpdated: {value: 0, required: false, hidden: true},
            },
            inputs: 1,
            outputs: 1,
            icon: "baseline_video_settings_black_24dp.png",
            label: function () {
                let parts = [];
                if (this.camProp && this.camProp.length > 0) parts.push(this.camProp.length > 20 ? this.camProp.substring(0, 20) + '...' : this.camProp);
                if (this.propVal && String(this.propVal).length > 0) parts.push(String(this.propVal).length > 20 ? String(this.propVal).substring(0, 20) + '...' : this.propVal);
                if (parts.length === 0) parts.unshift(this._def.paletteLabel);
                else if (parts.length === 1) parts.unshift("Config");
                return parts.join(' - ');
            },
            oneditprepare: function () {
                const camController = new CameraController($, {
                    camlocation: this.camlocation,
                    host: this.host,
                    camId: this.camId,
                    camProp: this.camProp,
                    propVal: this.propVal,
                    access_mode: this.access_mode,
                    node_type: this.node_type,
                    camProperty: this.camProperty,
                })
                camController.startListeners();
                window.camController = camController;  // debugging

                document.getElementById("fvCamForm").addEventListener('updateToolContext',
//                    (e) => this.setFVContext(e),
                    (e) => {
                        console.log("updateToolContext", e.detail);
                        this.camlocation = e.detail.camlocation
                        this.host = e.detail.host
                        this.camId = e.detail.camId
                        this.camProp = e.detail.camProp
                        this.propVal = e.detail.propVal
                        this.access_mode = e.detail.access_mode;
                        this.node_type = e.detail.node_type;
                        this.camProperty = e.detail.camProperty;
                        this.lastUpdated = new Date().getTime()
                    },
                    {capture: false}
                );
            }
        });


        RED.nodes.registerType('release-camera', {
            category: 'Flexible Vision',
            paletteLabel: 'Release Camera',
            color: '#F44336',
            defaults: {
                camlocation: {type: "camera-server", required: true},
                camId: {value: "", required: true}
            },
            inputs: 1,
            outputs: 1,
            icon: "baseline_videocam_off_black_24dp.png",
            label: function () {
                if (this.camId && this.camId.length > 0) {
                    return 'Release ' + this.camId;
                } else {
                    return this._def.paletteLabel;
                }
            },
            oneditprepare: function () {
                const camController = new CameraController($, {
                    camlocation: this.camlocation,
                    camId: this.camId
                })
                camController.startListeners();
                window.camController = camController; // debugging

                document.getElementById("fvCamForm").addEventListener('updateToolContext',
                    (e) => {
                        console.log("updateCamReleaseContext", e.detail);
                        this.camlocation = e.detail.host
                        this.camId = e.detail.camId
                    },
                    {capture: false}
                );
            }
        });


        RED.nodes.registerType('open-camera', {
            category: 'Flexible Vision',
            paletteLabel: 'Open Camera',
            color: '#43A047',
            defaults: {
                camlocation: {type: "camera-server", required: true},
                camId: {value: "", required: true}
            },
            inputs: 1,
            outputs: 1,
            icon: "outline-videocam-24px.svg",
            label: function () {
                if (this.camId && this.camId.length > 0) {
                    return 'Open ' + this.camId;
                } else {
                    return this._def.paletteLabel;
                }
            },
            oneditprepare: function () {
                const camController = new CameraController($, {
                    camlocation: this.camlocation,
                    camId: this.camId
                })
                camController.startListeners();
                window.camController = camController; // debugging

                document.getElementById("fvCamForm").addEventListener('updateToolContext',
                    (e) => {
                        this.camlocation = e.detail.host
                        this.camId = e.detail.camId
                    },
                    {capture: false}
                );
            }
        });

        RED.nodes.registerType('update-inference', {
            category: 'Flexible Vision',
            paletteLabel: 'Update Inference Object',
            color: '#ba78ff',
            defaults: {
                fvconfig: {type: "server-settings", required: true},
                inferenceobj: {value: ""},
                metadata: {value: ""}
            },
            inputs: 1,
            outputs: 1,
            icon: "hub_black_24dp.svg"
        });

    })();
</script>
